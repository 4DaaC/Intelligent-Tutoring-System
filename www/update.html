<!DOCTYPE html>
<html>
<head>
  
  <title>jQuery Mobile page</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="css/jquery.mobile-1.0.min.css" /> 
    <link rel="stylesheet" href="css/jquery-mobile-theme-ru.css" />
  <script src="js/jquery-1.7.min.js"></script>
  <script src="js/phonegap-1.2.0.js"></script>
  <script src="js/crypt.js"></script>
  <script>
  $(document).bind("mobileinit", function(){
    $.mobile.page.prototype.options.addBackBtn = true;
  });
  </script> 
  <script src="js/jquery.mobile-1.0.min.js"></script>
  <script src="js/its.js"></script>
</head>
<body>
<div data-role="page" id="update" data-add-back-btn="true">
  <div data-role="header">
    <a data-rel="back" data-icon="arrow-l">Back </a>
    <h1>Update</h1>
  </div>
  <div data-role="content">
    <div id="update-button" data-role="button" style="font-size:80%">Download/Update Your Classes</div>
    <div id="view-all-button" data-role="button">View Individual Quizzes</div>
  </div>
</div>

<div data-role="page" id="update-profs">
  <div data-role="header">
    <h1>Professors</h1>
  </div>
  <div data-role="content">
    <ul data-role="listview">
    </ul>
  </div>
</div>

<div data-role="page" id="update-classes">
  <div data-role="header">
    <h1>Classes</h1>
  </div>
  <div data-role="content">
    <ul data-role="listview">
    </ul>
  </div>
</div>

<div data-role="page" id="update-quizzes">
  <div data-role="header">
    <h1>Quizzes</h1>
  </div>
  <div data-role="content">
    <ul data-role="listview">
    </ul>
  </div>
</div>
<script>
$('#update-button').bind('click',function(){
  if(loggedIn()){
    var errored = false;
    downloadProfs(function(profs,error){
      if(error){
        errored = true;
      }else{
        for(pidx in profs){
          downloadClasses(profs[pidx].username,function(classes,error){
            if(error){
              errored = true;
            }else{
              for(cidx in classes){
                downloadQuizzes(classes[cidx].cid,function(quizzes,error){
                  if(error){
                    errored = true
                  }
                  if(errored){
                    alert("One or more downloads failed");
                  }else{
                    alert("Update Complete!");
                  }
                });
              }
            }
          });
        }
      }

    });
    console.log('clicked');
  }else{
    alert('You must be logged in to update.');
  }
});

$('#view-all-button').bind('click',function(){
  if(loggedIn()){
    downloadProfs(function(profs,error){
      if(error){
        alert(error);
      }else{
        var page = $('#update-profs');
        console.log(page.length);
        var content = page.children(":jqmData(role=content)");
        content.children('ul').html('');
        if(profs.length == 0){
          content.children('ul').html('<li>No Professors Found</li>');
        }else{
          var markup = "";
          for(prof in profs){
            markup+= "<li><a class='prof-update-link' href='#update-classes' its-uid='" + profs[prof].uid + "'>" + profs[prof].username + "</a></li>";
          }
          console.log(markup);
          content.children('ul').html(markup);
        }
        $.mobile.changePage(page);
        content.children('ul').listview('refresh');
        bindClassLinks();
      }
    });
  }else{
    alert('You must be logged in to view classes.');
  }
});
var bindClassLinks = function(){
  $('.prof-update-link').bind('click',function(){
    var profName = $(this).html();
    var profUid = $(this).attr('its-uid');
    downloadClasses(profName,function(classes,error){
      if(error){
        alert(error);
      }else{
        var page = $('#update-classes');
        var head = page.children(":jqmData(role=header)");
        var content = page.children(":jqmData(role=content)");
        content.children('ul').html('');
        head.children('h1').html(profName + "'s Classes");
        if(classes.length == 0){
          content.children('ul').html('<li>No Classes Found</li>');
        }else{
          var markup = "";
          for(idx in classes){
            markup+= "<li><a class='class-update-link' href='#update-quizzes' its-cid='" + classes[idx].cid + "'>" + classes[idx].name + "</a></li>";
          }
          console.log(markup);
          content.children('ul').html(markup);
        }
        $.mobile.changePage(page);
        content.children('ul').listview('refresh');
        bindQuizLinks();
      }
    });
  });
}

var bindQuizLinks = function(){
  $('.class-update-link').bind('click',function(){
    var className = $(this).html();
    var cid = $(this).attr('its-cid');
    downloadQuizzes(cid,function(quizzes,error){
      if(error){
        alert(error);
      }else{
        var page = $('#update-quizzes');
        var head = page.children(":jqmData(role=header)");
        var content = page.children(":jqmData(role=content)");
        content.children('ul').html('');
        head.children('h1').html(className);
        if(quizzes.length == 0){
          content.children('ul').html('<li>No Quizzes Found</li>');
        }else{
          var markup = "";
          for(idx in quizzes){
            markup+= "<li>" + quizzes[idx].name +"<div class='quiz-update-link' data-role='button' its-qid='" 
              + quizzes[idx].qid + "'>Download Quiz</div></li>";
          }
          console.log(markup);
          content.children('ul').html(markup);
        }
        $.mobile.changePage(page);
        content.children('ul').listview('refresh');
      }
    });
  });
}
</script>
</body>
</html>
